<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$EARTH - ç‚¹äº®åœ°çƒ + å…¨çƒèŠå¤© ğŸŒğŸ’¬ğŸš€</title>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link rel="icon" href="logo.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; font-family: Arial, sans-serif; overflow: hidden; }
        #cesiumContainer { width: 100vw; height: 100vh; }
        .panel { position: fixed; top: 20px; left: 20px; z-index: 999; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); color: white; min-width: 300px; }
        h1 { text-align: center; font-size: 2.2em; margin-bottom: 15px; background: linear-gradient(45deg, #00ff88, #0099ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        button, input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; }
        button { background: linear-gradient(45deg, #00ff88, #0099ff); cursor: pointer; font-weight: bold; transition: transform 0.3s; }
        button:hover { transform: scale(1.05); }
        .buy-btn { background: linear-gradient(45deg, #ff6b6b, #ffd93d) !important; }
        .share-btn { background: linear-gradient(45deg, #1da1f2, #0d8bd9) !important; }
        .hidden { display: none; }
        input { background: rgba(255,255,255,0.1); color: white; }
        #chatBox { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 400px; background: rgba(0,0,0,0.8); border-radius: 15px; padding: 10px; display: flex; flex-direction: column; z-index: 999; backdrop-filter: blur(10px); }
        #messages { flex: 1; overflow-y: auto; margin-bottom: 10px; color: white; }
        #chatInput { width: 100%; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; }
        footer { position: fixed; bottom: 20px; left: 20px; color: #aaa; font-size: 0.9em; }
        @media (max-width: 768px) { .panel, #chatBox { left: 10px; right: 10px; min-width: auto; } #chatBox { width: auto; height: 300px; } }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="panel">
        <h1>ğŸŒ $EARTH</h1>
        <p style="text-align:center; margin-bottom:20px; opacity:0.9;">è¿æ¥é’±åŒ…ï¼Œç‚¹äº®+èŠå¤©+åˆ†äº«èµš5%ï¼</p>
        <button onclick="connectWallet()">ğŸ”— è¿æ¥Phantom</button>
        <div id="locPanel" class="hidden">
            <input id="inviteCode" placeholder="è¾“å…¥é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰" />
            <button onclick="getLocation()">ğŸ“ æˆæƒä½ç½®ç‚¹äº®</button>
            <button onclick="generateInviteCode()" class="hidden" id="shareBtn">ğŸ“¤ åˆ†äº«é‚€è¯·ç èµš5%</button>
        </div>
        <button class="buy-btn" onclick="window.open('https://dev.fun', '_blank')">ğŸ›’ ä¹°$EARTH</button>
    </div>
    
    <div id="chatBox" class="hidden">
        <div id="messages"></div>
        <input id="chatInput" placeholder="èŠç‚¹å•¥ï¼ˆè‡ªåŠ¨ç¿»è¯‘ï¼‰..." onkeypress="if(event.key==='Enter') sendMessage();" />
    </div>
    
    <footer>
        <p>å…¬å¹³å‘å°„ | 0%ç¨ | DYOR/NFA | <a href="#" style="color:#00ff88;" onclick="window.open('https://dexscreener.com/solana/CA_SOON', '_blank')">DexScreener (CAæ›´æ–°)</a></p>
    </footer>

    <script>
        let viewer, entities = [], socket, userPubkey, userLat, userLng, inviteCode;
        const MINT = 'YOUR_MINT_HERE'; // ğŸ”¥ å‘å¸åæ›¿æ¢CA
        const siteUrl = 'YOUR_SITE_URL'; // ğŸ”¥ éƒ¨ç½²åæ›¿æ¢Vercel URL
        const backendUrl = 'YOUR_BACKEND_URL'; // ğŸ”¥ åç«¯URL (Vercel)

        // åˆå§‹åŒ–3Dåœ°çƒ
        function initMap() {
            Cesium.Ion.defaultAccessToken = '';
            viewer = new Cesium.Viewer('cesiumContainer', {
                terrain: Cesium.Terrain.fromWorldTerrain(),
                imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url: '//tile.openstreetmap.org/{z}/{x}/{y}.png' }),
                baseLayerPicker: false, timeline: false, animation: false
            });
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(0, 0, 15000000) });
            animateEarth();
        }

        function animateEarth() {
            let angle = 0;
            setInterval(() => {
                angle += 0.1;
                viewer.scene.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(angle % 360, 0, 15000000) });
            }, 50);
        }

        // è¿æ¥Phantom
        async function connectWallet() {
            if (!window.solana) return alert('å®‰è£…Phantomï¼');
            try {
                await window.solana.connect();
                userPubkey = window.solana.publicKey.toString();
                const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
                const accounts = await connection.getParsedTokenAccountsByOwner(
                    new solanaWeb3.PublicKey(userPubkey),
                    { mint: new solanaWeb3.PublicKey(MINT) }
                );
                if (accounts.value.length > 0 && accounts.value[0].account.data.parsed.info.tokenAmount.uiAmount > 0) {
                    document.getElementById('locPanel').classList.remove('hidden');
                    document.getElementById('chatBox').classList.remove('hidden');
                    initChat();
                    alert(`âœ… æŒæœ‰ ${accounts.value[0].account.data.parsed.info.tokenAmount.uiAmount.toFixed(2)} $EARTHï¼ç‚¹äº®+èŠå¤©`);
                    const code = document.getElementById('inviteCode').value.trim();
                    if (code) {
                        localStorage.setItem('referrerCode', code);
                        fetch(`${backendUrl}/api/invite`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ pubkey: userPubkey, code }) 
                        });
                    }
                } else alert('âŒ æœªæŒæœ‰ï¼Œå¿«å»ä¹°ï¼');
            } catch (e) { alert('è¿æ¥å¤±è´¥ï¼Œé‡è¯•'); }
        }

        // ä½ç½®ç‚¹äº®
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    addMarker(userLat, userLng);
                    document.getElementById('shareBtn').classList.remove('hidden');
                }, () => alert('æˆæƒå¤±è´¥ï¼Œæ‰‹åŠ¨è¯•è¯•ï¼Ÿ'));
            } else alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
        }

        function addMarker(lat, lng) {
            const entity = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lng, lat, 10000),
                point: { pixelSize: 20, color: Cesium.Color.fromCssColorString(`hsl(${Math.random()*360}, 100%, 50%)`), outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                description: `Degen at (${lat.toFixed(2)}, ${lng.toFixed(2)})`
            });
            entities.push(entity);
            viewer.flyTo(entity);
            alert('ğŸ‰ ç‚¹äº®æˆåŠŸï¼åˆ†äº«é‚€è¯·ç èµš5%');
        }

        // ç”Ÿæˆé‚€è¯·ç 
        function generateInviteCode() {
            inviteCode = btoa(userPubkey.slice(0, 8) + Date.now()).slice(0, 10);
            localStorage.setItem('inviteCode', inviteCode);
            const text = `æˆ‘ç‚¹äº®$EARTHåœ¨(${userLat.toFixed(2)}, ${userLng.toFixed(2)})! ç”¨æˆ‘çš„é‚€è¯·ç  ${inviteCode} åŠ å…¥: ${siteUrl} #EARTHLightUp`;
            html2canvas(document.getElementById('cesiumContainer')).then(canvas => {
                const img = canvas.toDataURL('image/png');
                const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                window.open(shareUrl);
                alert('åˆ†äº«åˆ°Xï¼åˆ«äººç”¨ä½ çš„ç ä¹°$EARTHï¼Œä½ å¾—5%ç©ºæŠ•ï¼');
                fetch(`${backendUrl}/api/invite`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ pubkey: userPubkey, code: inviteCode }) 
                });
            });
        }

        // èŠå¤©
        function initChat() {
            socket = io(backendUrl);
            socket.on('message', msg => {
                const div = document.createElement('div');
                div.textContent = `${msg.user}: ${msg.text} (${msg.lang})`;
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView();
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            const res = await fetch('https://libretranslate.com/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: text, source: 'auto', target: 'en' })
            });
            const data = await res.json();
            const translated = data.translatedText || text; // åå¤‡
            socket.emit('message', { user: userPubkey.slice(0,4), text: translated, lang: 'EN' });
            input.value = '';
        }

        window.onload = initMap;
    </script>
</body>
</html>
